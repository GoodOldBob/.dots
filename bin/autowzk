#!/bin/bash
# Runs colorz2 on an image file to get 6 colors, then stuffs those colors
# through wzk.

# TODO: handle n_primary, b_primary

# http://stackoverflow.com/a/13221491
exists() {
  if [ "$2" != in ]; then
    echo "Incorrect usage."
    echo "Correct usage: exists {key} in {array}"
    return
  fi
  eval '[ ${'$3'[$1]+muahaha} ]'
}

usage() {
  echo "USAGE: autowzk [image file] (primary color) (secondary color)"
  echo "Available colors: 2 (red),  3 (green),   4 (yellow),"
  echo "                  5 (blue), 6 (magenta), 7 (cyan)"
  echo "Defaults: primary=2, secondary=3"
  exit 1
}

declare -A COLORS
COLORS=(
  [2]=red
  [3]=green
  [4]=yellow
  [5]=blue
  [6]=magenta
  [7]=cyan
)

read -r -d '' TEMPLATE << EOM
wallpapers: "%s"

n_red: "%s"
b_red: "%s"
n_green: "%s"
b_green: "%s"
n_yellow: "%s"
b_yellow: "%s"
n_blue: &n_primary "%s"
b_blue: &b_primary "%s"
n_magenta: "%s"
b_magenta: "%s"
n_cyan: "%s"
b_cyan: "%s"

n_primary: *n_primary
b_primary: *b_primary

ncmpcpp_primary: "%%s"
ncmpcpp_secondary: "%%s"
ncmpcpp_primary_n: "%%s"
ncmpcpp_secondary_n: "%%s"
EOM

# Sanity checks
[ "$#" -lt 1 ] || [ "$#" -gt 3 ] && usage
[ ! -f "$1" ] && usage

# Setting defaults
img="$1"

if [ -z "$2" ]; then
  # Default
  primary="2"
else
  exists "$2" in COLORS 2>/dev/null && primary="$2" || usage
fi

if [ -z "$3" ]; then
  # Default
  secondary="3"
else
  exists "$3" in COLORS 2>/dev/null && secondary="$3" || usage
fi

echo "Using primary=$primary, secondary=$secondary..."

colors="$(colorz2 --no-preview -n 6 "$img")"
[ "${PIPESTATUS[0]}" -ne 0 ] && exit 1

yaml="$(echo "$colors" | xargs printf "$TEMPLATE" "$(readlink -f "$img")")"
yaml="$(printf "$yaml" "${COLORS[$primary]}" "${COLORS[$secondary]}" \
                       "$primary"            "$secondary" )"

wzk <(echo "$yaml")
