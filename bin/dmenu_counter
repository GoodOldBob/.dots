#!/usr/bin/env python
description = """
Counts how many times a dmenu entry has been run and
reorders accordingly. Executes demnu as provided by
the remaining arguments.
"""

import os
import sys
import json
import argparse
from subprocess import Popen, PIPE
from collections import defaultdict

# Get dmenu and counter_file
parser = argparse.ArgumentParser(description=description,
    usage="%s [-h] [-counter COUNTER] [dmenu ...]" % sys.argv[0])
parser.add_argument('-counter',
    help="""
    the file to use for counting the number of times
    a program has executed. Uses ~/.dmenu_counter.json
    by default.
    """,
    type=str,
    default='~/.dmenu_counter.json')
args, dmenu = parser.parse_known_args()

counter_file = os.path.expanduser(args.counter)

# Check if we have a dmenu
if not len(dmenu):
  parser.error("No dmenu provided!")

counter = defaultdict(int)

# Try to load existing dictionary
try:
  with open(counter_file, 'r') as f:
    counter.update(json.load(f))

# Does not exist - proceed with an empty dict
except IOError:
  pass

# Add stdin items to dict
for line in sys.stdin:
  line = line.rstrip('\n')
  if line not in counter:
    counter[line] = 0

# Get a list of sorted items
items = [k for k, v in sorted(
  counter.iteritems(),
  # Sort decreasing val, then increasing key
  key=lambda x: (-x[1], x[0]),
)]

# Open up whatever was passed in as args
dmenu = Popen(sys.argv[1:], stdin=PIPE, stdout=PIPE)
selected = dmenu.communicate('\n'.join(items))[0].rstrip('\n')

# Record the results
if selected:
  counter[selected] += 1
with open(counter_file, 'w') as f:
  json.dump(counter, f)

# Output our selection
print(selected)
