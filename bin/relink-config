#!/bin/bash

# Base directory to link from
BASE_DIR=~/dotfiles

# Associative array: to link -> real
declare -A TO_LINK
TO_LINK=(
  [home]=~
)

# Check for directory existence
if [ ! -d "$BASE_DIR" ]; then
  echo "Base directory $BASE_DIR does not exist!"
  exit 1
fi

for key in "${!TO_LINK[@]}"; do

  # Get the path of the next directory to link
  dir="${BASE_DIR%%/}/$key"
  dir="${dir%%/}/"

  # Check for directory existence
  if [ ! -d "$dir" ]; then
    echo "To link directory $dir does not exist! Skipping..."
    continue
  fi
  
  # Print summary
  echo
  echo "LINKING: $dir -> ${TO_LINK[$key]}"
  for src in $(find $dir); do

    # Attach the value to the filename
    dest="${TO_LINK[$key]%%/}/${src##$dir}"

    # Skip directories
    if [ -d "$dest" ]; then
      continue
    fi

    echo "  $src ->"
    echo "    $dest"
    echo
  done

  # Ask for confirmation
  read -r -p "  Are you sure? [y/N] " response
  case $response in
    [yY][eE][sS]|[yY]) 
      echo "  Proceeding..."
      ;;
    *) # Skip
      echo "  Skipping..."
      continue
      ;;
  esac

  # Do the linking
  for src in $(find $dir); do

    # Attach the value to the filename
    dest="${TO_LINK[$key]%%/}/${src##$dir}"

    # Skip directories
    if [ -d "$dest" ]; then
      continue
    fi

    # Extract the directory name
    dest_dir="$(dirname $dest)"
    mkdir -p $dest_dir
    cd $dest_dir

    # Remove and link
    rm $dest
    ln -s $src
  done
done
